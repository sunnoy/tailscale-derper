# .github/workflows/auto-rerun.yml
name: Auto Rerun Daily Derper Build (on failure)

on:
  workflow_run:
    workflows: ["Daily Derper Build"]   # 监听 A
    types: [completed]

permissions:
  actions: write
  contents: read

jobs:
  rerun-on-failure:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.run_attempt < 3      # 最多重试 2 次（首次+2 次 = 3 次）
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Re-run the entire workflow run
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Previous run attempt: ${{ github.event.workflow_run.run_attempt }}"
          # 重试整次，而不是只重试失败 job
          gh api \
            -X POST \
            repos/${{ github.repository }}/actions/runs/${RUN_ID}/rerun
